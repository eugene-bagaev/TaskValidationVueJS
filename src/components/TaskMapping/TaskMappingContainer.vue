<template >




<v-app :dark="dark">
		<div style="padding-top: 70px;">
	 <Header @changeTheme="dark=!dark"/>
		<v-card class="mx-auto" >
			<v-window v-model="step">
				<v-window-item :value="0">
					<template>
						<v-toolbar flat color="secondary">
							
								<v-toolbar-title>TASK MAPPING</v-toolbar-title>
					
							<v-spacer></v-spacer>
							<v-btn color="primary"  @click="createTask">CREATE TASK</v-btn>
						</v-toolbar>
					</template>

					<v-card-text>
						<v-flex xs12>
							<!-- <v-list>
								
								<v-list-group
									sub-group
									v-for="(row, index) in Tasks"
									:key="index"
									:prepend-icon="row.action"
									no-action
								>
									<template v-slot:activator>
										<v-list-tile>
											<v-list-tile-content>
												<v-list-tile-title>
													<span class="font-weight-light body-1">Task Number:</span>
													{{ index + 1}}
												</v-list-tile-title>
											</v-list-tile-content>
										</v-list-tile>
											<v-btn
														fab
														icon
														float
														pre
														color="white"
														flat
														small
														 @click="editTask(row)"
													>
														<v-icon>edit</v-icon>
													</v-btn>
													<v-btn
														fab
														icon
														float
														color="white"
														flat
														small
														@click="removeTask(index)"
													><v-icon>delete</v-icon>
                                      		  		</v-btn>
									</template>

									<v-list-tile v-for="(subItem, name, subIndex) in row" :key="subIndex">
										<v-list-tile-content>
											<v-list-tile-title>
												<span class="font-weight-light body-1">{{subItem}}</span>

											</v-list-tile-title>
										</v-list-tile-content>
									</v-list-tile>
								</v-list-group>
							
							</v-list> -->



							<v-flex xs12>
								<v-expansion-panel popout>
									<v-expansion-panel-content
										v-for="(tasksArr, index) in Tasks"
										:key="index"
									>
										<template v-slot:header>
											<p class="text-lg-right">
												<span class="font-weight-light body-1">Task Number:</span>
													{{ index + 1}}
											</p>
											<p class="text-xs-right">
													<v-btn
														fab
														icon
														float
														pre
														color="white"
														flat
														small
														 @click="editTask(tasksArr)"
													>
														<v-icon>edit</v-icon>
													</v-btn>
													<v-btn
														fab
														icon
														float
														color="white"
														flat
														small
														@click="removeTask(index)"
													><v-icon>delete</v-icon>
                                      		  		</v-btn>
											</p>
										</template>
										<v-card>
											

												<span class="font-weight-light body-1"> </span>			
													<v-list >
														<v-list-group
															sub-group
															 v-for="(tasksMeta, name, subIndex) in tasksArr" :key="subIndex"
															:prepend-icon="tasksArr.action"
															no-action
															 v-if="tasksMeta.length > 0"
														>
															<template v-slot:activator>
																<v-list-tile>
																	<v-list-tile-content>
																		<v-list-tile-title>
																			<span class="font-weight-light body-1">{{ name.slice(0,-5) }} :</span>
																		</v-list-tile-title>
																	</v-list-tile-content>
																</v-list-tile>

															</template>

															<v-list-tile v-for="(task, indTask) in tasksMeta" :key="indTask">
																<v-list-tile-content>
																	<v-list-tile-title>
																		<span class="font-weight-light body-1">Name: {{task.name}}</span>
																		 <!-- {{task}} -->
																	</v-list-tile-title>
																</v-list-tile-content>
															</v-list-tile>
														</v-list-group>
													
													</v-list>


										
										</v-card>
									</v-expansion-panel-content>
								</v-expansion-panel>
						</v-flex>


							<v-layout align-end justify-end>
								<v-layout align-end justify-end>
									<v-btn color="primary" dark @click="getTasks">GETTTTTTTTTT</v-btn>
									<v-btn color="primary" dark>Back</v-btn>
									<v-btn color="primary" dark @click="saveTasks" v-if="Tasks.length>0">SAVE TASKS</v-btn>
								</v-layout>
								<!-- <v-btn  color="primary" dark @click="cancel">Cancel</v-btn>
								<v-btn  color="primary" dark @click="createTask">CREATE TASK</v-btn>-->
							</v-layout>
						</v-flex>
					</v-card-text>
				</v-window-item>

				<v-window-item :value="1">
					<component :is="component" v-if="component" ref="task"/>
				</v-window-item>
			</v-window>
		</v-card>
		</div>
		</v-app>
	
</template>
<script>
import oneTask from "./oneTask";
import Header from "../Header";
export default {
	components: {
		oneTask,
		Header
	},
	name: "container",
	data: () => ({
		dark: true,
		step: 0,
		mode:"new",
		Tasks: [],
		newTask: {
			sObjectTasks: [],
			apexClassTasks: [],
			apexPageTasks: [],
			triggerTasks: [],
			testTasks: []
		},
		component: null
	}),
	created() {
            this.getTaskMapping();
    },
	mounted() {
		this.$root.$on("createTask", task => {
			this.step++;
			console.log("emit createTask ");
			if(this.mode == "new"){
				this.Tasks.push(task);
			}
			var that = this;
			setTimeout(function() {
				that.component = null;
				that.mode = "new";
			}, 500);
		});
		this.$root.$on("cancelTask", () => {
			this.step++;
			this.mode = "new";
			this.component = null;
		});
	},
	methods: {
		getTaskMapping: function(index) {
			this.$http.get('http://localhost:8080/getTaskMapping').then(response => {
			   console.log ( response.body);
               this.Tasks = response.body;     
            });
		},
		editTask: function(task) {
			this.step++;
			var that = this;
			this.mode = "edit";
			this.component = "oneTask";
			setTimeout(function() {
				that.$refs.task.Task = task;
			}, 200);
		},
		removeTask: function(index) {
			this.Tasks.splice(index, 1);
		},
		createTask: function() {
			console.log(" createTask ");
			this.step++;
			this.mode = "new";
			var that = this;
			setTimeout(function() {
			    that.component = "oneTask";
			}, 250);
		},
		saveTasks: function() {
			console.log(" saveTasks ");
			const tasks = JSON.stringify(this.Tasks);
            console.log(tasks);
//      'http://localhost:8080/getUsers' 
//      export var HTTP_USER_CREDS_URL = (window.location.href.includes('localhost')) 
//      ? 'http://localhost:8080/getUsers' : 'https://task-validation-lc.herokuapp.com/getUsers';

            this.$http.post('http://localhost:8080/saveTaskMapping', tasks).then(() => {
                // eslint-disable-next-line no-console
                console.log('SUCCESS');
            }, () => {
                // eslint-disable-next-line no-console
                console.log('ERROR');
            });

			// this.$http.get(HTTP_USER_CREDS_URL).then(response => {
			// 	let groups = [];
			// 	response.body.forEach((elem, i) => {
			// 		// this.users.push({
			// 		// 	index: i,
			// 		// 	userName: elem.userName,
			// 		// 	password: elem.password,
			// 		// 	checked: false,
			// 		// 	group: elem.group,
			// 		// 	fio: elem.fio
			// 		// });
			// 		// groups.push(elem.group);
			// 	});
			// 	this.groups = new Set(groups);
			// 	this.$root.$emit("setState", false);
			// });
        },
        getTasks: function() {
			this.$http.get("http://localhost:8080/getTaskMapping").then(response => {
				console.log(response.body);
			});
		},


	}
};
</script>

<style scoped>
</style>